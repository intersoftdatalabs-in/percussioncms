<project name="dbSetup" default="setup" basedir=".">

    <property name="rootdir" value="D:\rel\cml1.0\system" />
	<property file="${rootdir}\perforce.properties"/>
	<property name="devClient" value="//cmlite/dev/main/..." />
	<property name="relClient" value="//cmlite/rel/1.0/..." />
	<property name="sharedDirBase" value="\\hades\public\Pre Release\CMLite\1.0" />
	<property file="${rootdir}\lastqabuild.txt"/>
	<property name="email.sub" value="New CMLite 1.0 QA Build Available" />
	<property name="email.to" value="Ma_RxDevelopers@percussion.com, Ma_RxQA@percussion.com, MA_RxDoc@percussion.com, luis_teixeira@percussion.com" />
	<property name="email.from" value="luis_teixeira@percussion.com" />
	
   <target name="setup">	  
	  <!-- Perforce intergration -->
	  <p4change description="Auto Intergration from ${devClient} to ${relClient}"/>
	  <p4integrate
		fromfile="${devClient}"
		tofile="${relClient}"
		change="${p4.change}"/>
	  <p4resolve
		view="${relClient}"
		resolvemode="theirs"/>
	  <p4submit change="${p4.change}"/>
	  
	  <!-- run build -->
	  <tstamp>
         <format property="CURRENT_YM" pattern="yyyyMM" />
      </tstamp>
      <tstamp>
         <format property="CURRENT_DAY" pattern="dd" />
      </tstamp>
	  
	  <ant antfile="${rootdir}\build.xml">
		<property name="MANUFACTURE" value="true"/>
		<property name="buildtype" value="QA"/>
		<property name="BUILDDATE" value="${CURRENT_YM}"/>
		<property name="BUILDCOUNT" value="${CURRENT_DAY}"/>
	  </ant>

	  <!-- copy setup folder -->
	  <property name="sharedDir" value="${sharedDirBase}/${CURRENT_YM}Q${CURRENT_DAY}" />
	  <delete dir="${sharedDir}"/>
	  <mkdir dir="${sharedDir}"/>
	  <copy todir="${sharedDir}">
		<fileset dir="${rootdir}\release\setup"/>
      </copy>
	  
	  <!-- Send email -->
	  <tstamp>
         <format property="TODAY" pattern="yyyy-MM-dd" />
      </tstamp>
	  
      <mail mailhost="outbounds8.obsmtp.com" mailport="25" subject="${email.sub}">
        <from address="${email.from}"/>
        <to address="${email.to}"/>
        <message>
Build available at:
${sharedDirBase}/${CURRENT_YM}Q${CURRENT_DAY}


Change list report can be seen here:

http://hera:9999/p4Reports/search.do?mode=1&amp;version=//cmlite/dev/main/...&amp;sdate=${last.build}&amp;edate=${TODAY}&amp;status=submitted
         </message>
      </mail>
	  <propertyfile file="lastqabuild.txt">
         <entry  key="last.build" value="${TODAY}"/>
      </propertyfile>
	  
   </target>
 
</project>
